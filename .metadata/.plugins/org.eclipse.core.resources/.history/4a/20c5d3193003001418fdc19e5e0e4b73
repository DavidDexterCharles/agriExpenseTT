package fragments;

import helper.DHelper;
import helper.DbHelper;
import helper.DbQuery;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;

import com.example.agriexpensett.CycleUseageRedesign;
import com.example.agriexpensett.HireLabour;
import com.example.agriexpensett.R;
import com.example.agriexpensett.localCycle;
import com.example.agriexpensett.R.drawable;
import com.example.agriexpensett.R.id;
import com.example.agriexpensett.R.layout;

import android.app.Fragment;
import android.app.FragmentTransaction;
import android.app.ListFragment;
import android.content.Context;
import android.content.Intent;
import android.database.sqlite.SQLiteDatabase;
import android.os.Bundle;
import android.app.FragmentManager;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.TextView;

public class FragmentViewCycles extends ListFragment{
	String type=null;
	SQLiteDatabase db;
	DbHelper dbh;
	ArrayList<localCycle> cList=new ArrayList<localCycle>();
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		dbh=new DbHelper(this.getActivity().getBaseContext());
		db=dbh.getReadableDatabase();
		try{//when called from hiring labour
			type=getArguments().getString("type");
		}catch (Exception e){}
		populateList();
		CycleListAdapter cycAdapt=new CycleListAdapter(getActivity().getBaseContext(), R.layout.cycle_list_item, cList);
		setListAdapter(cycAdapt);
	}
	
	private void populateList() {
		DbQuery.getCycles(db, dbh, cList);
	}

	@Override
	public View onCreateView(LayoutInflater inflater, ViewGroup container,
		Bundle savedInstanceState) {
		//returns the inflated layout which contains the listview
		return inflater.inflate(R.layout.fragment_choose_purchase, container, false);
	}
	
	public class CycleListAdapter extends ArrayAdapter<localCycle> {
		  
		 Context myContext;
		
		 public CycleListAdapter(Context context, int textViewResourceId, ArrayList<localCycle> objects) {
			 super(context, textViewResourceId, objects);
			 myContext = context;
		  }
		
		  @Override
		  public View getView(int position, View convertView, ViewGroup parent) {
			   //return super.getView(position, convertView, parent);
			   
			   LayoutInflater inflater = (LayoutInflater)myContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
			   
			   //Get Layout of An Item and Store it in a view
			   View row=inflater.inflate(R.layout.cycle_list_item, parent, false);
			   //get the elements of that view and set them accordingly
			   TextView Crop=(TextView)row.findViewById(R.id.tv_cycleList_crop);
				
			   localCycle currCycle=cList.get(position);
			   int cid=currCycle.getCropId();
				String txt=DbQuery.findResourceName(db, dbh, cid);//getting the crop name
				Crop.setText(txt);
				ImageView imageView=(ImageView)row.findViewById(R.id.icon_purchaseType);
				if(txt.equals("tomatoe")){
					imageView.setImageResource(R.drawable.icon_tomatoe3);
				}else if(txt.equals("cassava")){
					imageView.setImageResource(R.drawable.icon_cassava1);
				}else if(txt.equals("sweet pepper")){
					imageView.setImageResource(R.drawable.icon_sweetpepper2);
				}
				
				
				TextView Land=(TextView)row.findViewById(R.id.tv_cycleList_Land);
				double qty=currCycle.getLandQty();
				txt=currCycle.getLandType();
				txt=qty+" "+txt;
				Land.setText(txt);
		
				TextView DateR=(TextView)row.findViewById(R.id.tv_cycleList_date);
				TextView DayL=(TextView)row.findViewById(R.id.tv_cycleList_day);
				Long dateMils=currCycle.getTime();
				Calendar calender=Calendar.getInstance();
				calender.setTimeInMillis(dateMils);
				
				cid=calender.get(Calendar.DAY_OF_WEEK);
				String[] days={"Sun","Mon","Tue","Wed","Thur","Fri","Sat"};
				
				if(cid==7){
					DayL.setText(days[6]);
				}else{
					DayL.setText(days[cid]);
				}
				Date d=calender.getTime();
				DateR.setText(d.toLocaleString());
				
				int i=0;
			   return row;
		  }
		  
		  //register click  
	 }
	@Override
	public void onListItemClick(ListView l, View v, int position, long id) {
		if(type==null){
			Intent nextActivity=new Intent(getActivity(),CycleUseageRedesign.class);
			nextActivity.putExtra("cycleMain",cList.get(position));
			startActivity(nextActivity);
		}else if(type.equals(DHelper.cat_labour)){
			FragmentManager fm=getFragmentManager();
			FragmentTransaction ft=fm.beginTransaction();
			ListFragment lf=new HireLabourLists();
			Bundle data=new Bundle();
			data.putString("type", "quantifier");
			data.putString("name", getArguments().getString("name"));
			((HireLabour)getActivity()).appendSub(",cycle#"+cList.get(position).getId());
			data.putParcelable("cycle", cList.get(position));
			lf.setArguments(data);
			ft.replace(R.id.NewCycleListContainer, lf);
			ft.commit();
		}
	}
}
